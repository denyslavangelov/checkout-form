!function(){function r(e){if(e&&!e._hasOurHandler){e._hasOurHandler=true;e.addEventListener('click',function(e){e.preventDefault();e.stopImmediatePropagation();openCustomCheckout();return false},{capture:true});const dot=document.createElement('span');dot.style.position='absolute';dot.style.top='3px';dot.style.right='3px';dot.style.width='6px';dot.style.height='6px';dot.style.backgroundColor='red';dot.style.borderRadius='50%';dot.style.zIndex='9999';if(getComputedStyle(e).position==='static'){e.style.position='relative'}e.appendChild(dot)}}const e=EventTarget.prototype.addEventListener;EventTarget.prototype.addEventListener=function(t,n,o){const i=e.call(this,t,n,o);if(n(this)&&t==="click"){console.log("Detected click handler being added to checkout button!");setTimeout(()=>{r(this)},100)}return i};const t=Object.getOwnPropertyDescriptor(HTMLElement.prototype,"onclick");function n(e){if(!e||!e.tagName)return false;const t=[{attr:"id",value:"CartDrawer-Checkout"},{attr:"name",value:"checkout"},{attr:"href",value:"/checkout"},{attr:"class",value:"checkout-button"},{attr:"class",value:"cart__checkout"},{attr:"class",value:"cart-checkout"},{attr:"data-action",value:"checkout"},{attr:"class",value:"shopify-payment-button__button"}];const n=t.some(t=>{const n=e.getAttribute(t.attr);return n&&(n===t.value||n.includes(t.value)||"/checkout"===t.value&&n.includes("/checkout"))});const o=e.textContent&&e.textContent.toLowerCase().includes("checkout");return n||o||e.closest('form[action="/cart"]')!==null}function o(){document.querySelectorAll(['#CartDrawer-Checkout','[name="checkout"]','[href="/checkout"]','[href*="/checkout"]',".checkout-button",".cart__checkout",".cart-checkout",'[data-action="checkout"]','form[action="/cart"] [type="submit"]',".shopify-payment-button__button"].join(",")).forEach(e=>{n(e)&&r(e)})}function i(){o()}Object.defineProperty(HTMLElement.prototype,"onclick",{set:function(e){const o=t.set.call(this,e);if(n(this)){console.log("Detected onclick property being set on checkout button!");setTimeout(()=>{r(this)},100)}return o},get:t.get});function start(){setInterval(i,500);const e=new MutationObserver(function(e){e.forEach(e=>{e.addedNodes.length&&o()})});e.observe(document.body,{childList:true,subtree:true,attributes:true,attributeFilter:["class","style","display","visibility"]});console.log("Persistent checkout button monitoring started")}"loading"===document.readyState?document.addEventListener("DOMContentLoaded",start):start()}();function openCustomCheckout(){console.log("Opening custom checkout...");const e=document.createElement("div");e.style.position="fixed";e.style.top="0";e.style.left="0";e.style.width="100%";e.style.height="100%";e.style.backgroundColor="rgba(0, 0, 0, 0.5)";e.style.zIndex="9998";e.style.display="flex";e.style.justifyContent="center";e.style.alignItems="center";const t=document.createElement("div");t.style.backgroundColor="white";t.style.padding="20px";t.style.borderRadius="8px";t.style.textAlign="center";t.style.maxWidth="90%";const n=document.createElement("div");n.style.width="40px";n.style.height="40px";n.style.margin="0 auto 15px auto";n.style.border="4px solid #f3f3f3";n.style.borderTop="4px solid #3498db";n.style.borderRadius="50%";n.style.animation="checkoutSpin 1s linear infinite";const o=document.createElement("style");o.textContent="@keyframes checkoutSpin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }";document.head.appendChild(o);const i=document.createElement("div");i.textContent="Зареждане на кошницата...";i.style.fontWeight="bold";t.appendChild(n);t.appendChild(i);e.appendChild(t);document.body.appendChild(e);fetch("/cart.js").then(e=>e.json()).then(t=>{console.log("Cart data retrieved:",t);window.shopifyCart=t;window.customCheckoutData={cartData:t,timestamp:(new Date).toISOString()};console.log("Cart data made globally available at window.shopifyCart and window.customCheckoutData.cartData");let n=document.getElementById("custom-checkout-modal");n=document.createElement("div");n.id="custom-checkout-modal";n.style.position="fixed";n.style.top="0";n.style.left="0";n.style.width="100%";n.style.height="100%";n.style.backgroundColor="rgba(0, 0, 0, 0.5)";n.style.zIndex="9999";n.style.display="flex";n.style.justifyContent="center";n.style.alignItems="center";const o=document.createElement("button");o.textContent="×";o.style.position="absolute";o.style.top="15px";o.style.right="15px";o.style.fontSize="24px";o.style.background="white";o.style.border="none";o.style.borderRadius="50%";o.style.width="30px";o.style.height="30px";o.style.cursor="pointer";o.style.display="flex";o.style.alignItems="center";o.style.justifyContent="center";o.style.zIndex="10000";o.addEventListener("click",function(){const e=document.getElementById("checkout-iframe");e&&e.contentWindow&&e.contentWindow.postMessage("close-checkout","*");document.body.removeChild(n)});n.appendChild(o);const i=document.createElement("iframe");i.id="checkout-iframe";i.style.width="100%";i.style.height="100%";i.style.maxWidth="600px";i.style.maxHeight="90vh";i.style.border="none";i.style.borderRadius="8px";i.style.backgroundColor="white";i.style.margin="auto";const s=new URL("https://checkout-form-zeta.vercel.app/iframe");s.searchParams.append("hasCart","true");if(window.innerWidth<768){i.style.maxWidth="100%";i.style.maxHeight="100%";i.style.height="100%";i.style.borderRadius="0";s.searchParams.append("isMobile","true");n.style.padding="0";o.style.top="10px";o.style.right="10px";o.style.width="36px";o.style.height="36px";o.style.fontSize="28px";o.style.backgroundColor="rgba(255, 255, 255, 0.9)";o.style.boxShadow="0 1px 3px rgba(0,0,0,0.2)"}else if(window.innerWidth<992){i.style.maxWidth="90%";i.style.maxHeight="95vh";s.searchParams.append("isTablet","true")}s.searchParams.append("viewportWidth",window.innerWidth.toString());s.searchParams.append("pixelRatio",(window.devicePixelRatio||1).toString());localStorage.setItem("tempCartData",JSON.stringify(t));window.addEventListener("message",function t(o){if(o.data==="request-cart-data"){console.log("Received request for cart data from iframe, sending data...");i.contentWindow&&i.contentWindow.postMessage({type:"cart-data",cart:t,metadata:{timestamp:(new Date).toISOString(),shopUrl:window.location.hostname,source:"shopify-integration",resent:true}},"*")}if(o.data==="checkout-ready"&&document.body.contains(e)){document.body.removeChild(e)}if(o.data==="checkout-closed"){document.body.contains(n)&&document.body.removeChild(n);window.removeEventListener("message",t)}});i.src=s.toString();n.appendChild(i);document.body.appendChild(n);i.onload=function(){console.log("Iframe loaded, sending cart data...");document.body.contains(e)&&document.body.removeChild(e);i.contentWindow.postMessage({type:"cart-data",cart:t,metadata:{timestamp:(new Date).toISOString(),shopUrl:window.location.hostname,source:"shopify-integration"}},"*");console.log("Sent cart data to iframe with details:",{itemCount:t.items.length,total:t.total_price,items:t.items.map(e=>({id:e.id,title:e.title,quantity:e.quantity}))});setTimeout(()=>{console.log("Sending cart data again after delay to ensure receipt...");i.contentWindow.postMessage({type:"cart-data",cart:t,metadata:{timestamp:(new Date).toISOString(),shopUrl:window.location.hostname,source:"shopify-integration",resent:true}},"*")},500)}}).catch(t=>{console.error("Error fetching cart data:",t);document.body.contains(e)&&document.body.removeChild(e);alert("Възникна грешка при зареждането на информацията за кошницата. Моля, опитайте отново.")})} 