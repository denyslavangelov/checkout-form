<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shopify Draft Order Creation Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .form-group {
            margin: 15px 0;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input, textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        textarea {
            height: 100px;
            font-family: monospace;
        }
        button {
            background: #007cba;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
            font-size: 16px;
        }
        button:hover {
            background: #005a87;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .result {
            margin-top: 20px;
            padding: 15px;
            border-radius: 4px;
            white-space: pre-wrap;
            font-family: monospace;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
        }
        .success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        .error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        .info {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
        }
        .warning {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .test-section h3 {
            margin-top: 0;
            color: #333;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🧪 Shopify Draft Order Creation Test</h1>
        <p>This tool tests creating draft orders using the Shopify Admin GraphQL API to verify our variant_id fixes.</p>
        
        <div class="form-group">
            <label for="storeUrl">Shopify Store URL:</label>
            <input type="text" id="storeUrl" placeholder="your-store.myshopify.com" value="">
        </div>
        
        <div class="form-group">
            <label for="accessToken">Admin API Access Token:</label>
            <input type="password" id="accessToken" placeholder="shpat_xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx">
        </div>
        
        <div class="form-group">
            <label for="customerId">Customer ID (optional):</label>
            <input type="text" id="customerId" placeholder="gid://shopify/Customer/123456789">
        </div>
        
        <div class="form-group">
            <label for="variantId">Product Variant ID:</label>
            <input type="text" id="variantId" placeholder="gid://shopify/ProductVariant/123456789" value="gid://shopify/ProductVariant/123456789">
        </div>

        <div class="test-section">
            <h3>Test 1: Create Draft Order with String Variant ID</h3>
            <p>Tests creating a draft order with a properly formatted string variant ID.</p>
            <button onclick="createDraftOrder('string')">Create Draft Order (String ID)</button>
            <div id="result1" class="result" style="display: none;"></div>
        </div>

        <div class="test-section">
            <h3>Test 2: Create Draft Order with Numeric Variant ID</h3>
            <p>Tests creating a draft order with a numeric variant ID to see if it fails.</p>
            <button onclick="createDraftOrder('numeric')">Create Draft Order (Numeric ID)</button>
            <div id="result2" class="result" style="display: none;"></div>
        </div>

        <div class="test-section">
            <h3>Test 3: Create Draft Order with Invalid Variant ID</h3>
            <p>Tests creating a draft order with an invalid variant ID format.</p>
            <button onclick="createDraftOrder('invalid')">Create Draft Order (Invalid ID)</button>
            <div id="result3" class="result" style="display: none;"></div>
        </div>

        <div class="test-section">
            <h3>Run All Tests</h3>
            <p>Runs all tests sequentially to get a comprehensive view.</p>
            <button onclick="runAllTests()">Run All Tests</button>
            <div id="resultAll" class="result" style="display: none;"></div>
        </div>
    </div>

    <script>
        const DRAFT_ORDER_CREATE_MUTATION = `
          mutation draftOrderCreate($input: DraftOrderInput!) {
            draftOrderCreate(input: $input) {
              draftOrder {
                id
                name
                status
                totalPrice
                subtotalPrice
                totalTax
                totalShippingPrice
                lineItems(first: 10) {
                  edges {
                    node {
                      id
                      title
                      quantity
                      originalUnitPrice
                      discountedUnitPrice
                      variant {
                        id
                        title
                        sku
                      }
                      product {
                        id
                        title
                      }
                    }
                  }
                }
                customer {
                  id
                  email
                  firstName
                  lastName
                }
                note
                tags
                createdAt
                updatedAt
              }
              userErrors {
                field
                message
              }
            }
          }
        `;

        function showResult(elementId, content, type = 'info') {
            const element = document.getElementById(elementId);
            element.style.display = 'block';
            element.className = `result ${type}`;
            element.textContent = content;
        }

        function hideResult(elementId) {
            const element = document.getElementById(elementId);
            element.style.display = 'none';
        }

        function getCredentials() {
            const storeUrl = document.getElementById('storeUrl').value.trim();
            const accessToken = document.getElementById('accessToken').value.trim();
            const customerId = document.getElementById('customerId').value.trim();
            const variantId = document.getElementById('variantId').value.trim();

            if (!storeUrl || !accessToken) {
                throw new Error('Please provide both Store URL and Access Token');
            }

            return { storeUrl, accessToken, customerId, variantId };
        }

        function createTestData(variantIdType) {
            const { storeUrl, accessToken, customerId, variantId } = getCredentials();
            
            let testVariantId;
            switch (variantIdType) {
                case 'string':
                    testVariantId = variantId || "gid://shopify/ProductVariant/123456789";
                    break;
                case 'numeric':
                    testVariantId = 123456789; // Numeric - should fail
                    break;
                case 'invalid':
                    testVariantId = "invalid-format"; // Invalid format - should fail
                    break;
                default:
                    testVariantId = variantId || "gid://shopify/ProductVariant/123456789";
            }

            return {
                storeUrl,
                accessToken,
                customerId: customerId || "gid://shopify/Customer/123456789",
                testData: {
                    input: {
                        customerId: customerId || "gid://shopify/Customer/123456789",
                        email: "test@example.com",
                        phone: "+1234567890",
                        
                        billingAddress: {
                            firstName: "Test",
                            lastName: "User",
                            address1: "123 Test Street",
                            city: "Test City",
                            province: "Test Province",
                            country: "US",
                            zip: "12345",
                            phone: "+1234567890"
                        },
                        
                        shippingAddress: {
                            firstName: "Test",
                            lastName: "User",
                            address1: "123 Test Street",
                            city: "Test City",
                            province: "Test Province",
                            country: "US",
                            zip: "12345",
                            phone: "+1234567890"
                        },
                        
                        lineItems: [
                            {
                                variantId: testVariantId,
                                quantity: 1,
                                customAttributes: [
                                    {
                                        key: "test_attribute",
                                        value: "test_value"
                                    }
                                ]
                            }
                        ],
                        
                        shippingLine: {
                            title: "Standard Shipping",
                            price: "5.99",
                            customAttributes: [
                                {
                                    key: "shipping_method",
                                    value: "standard"
                                }
                            ]
                        },
                        
                        note: `Test draft order created to verify variant_id fixes (${variantIdType} format)`,
                        tags: ["test", "variant-id-fix", variantIdType],
                        useCustomerDefaultAddress: false,
                        allowPartialAddresses: true
                    }
                }
            };
        }

        async function createDraftOrder(variantIdType) {
            const resultId = `result${variantIdType === 'string' ? '1' : variantIdType === 'numeric' ? '2' : '3'}`;
            hideResult(resultId);
            
            try {
                const { storeUrl, accessToken, testData } = createTestData(variantIdType);
                
                showResult(resultId, `🔄 Creating draft order with ${variantIdType} variant ID...`, 'info');
                
                const response = await fetch(`https://${storeUrl}/admin/api/2025-01/graphql.json`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Shopify-Access-Token': accessToken,
                    },
                    body: JSON.stringify({
                        query: DRAFT_ORDER_CREATE_MUTATION,
                        variables: testData
                    })
                });

                const data = await response.json();
                
                if (data.errors) {
                    const errorMessages = data.errors.map(e => e.message).join('\n');
                    const isVariantError = errorMessages.includes('variant') || errorMessages.includes('Variant');
                    
                    if (isVariantError) {
                        showResult(resultId, `🚨 FAILED: Variant ID validation error\n\nErrors:\n${errorMessages}\n\nFull Response:\n${JSON.stringify(data, null, 2)}`, 'error');
                    } else {
                        showResult(resultId, `✅ PASSED: No variant_id errors (different error)\n\nErrors:\n${errorMessages}\n\nFull Response:\n${JSON.stringify(data, null, 2)}`, 'success');
                    }
                } else if (data.data?.draftOrderCreate?.userErrors?.length > 0) {
                    const errorMessages = data.data.draftOrderCreate.userErrors.map(e => e.message).join('\n');
                    const isVariantError = errorMessages.includes('variant') || errorMessages.includes('Variant');
                    
                    if (isVariantError) {
                        showResult(resultId, `🚨 FAILED: Variant ID validation error\n\nUser Errors:\n${errorMessages}\n\nFull Response:\n${JSON.stringify(data, null, 2)}`, 'error');
                    } else {
                        showResult(resultId, `✅ PASSED: No variant_id errors (different error)\n\nUser Errors:\n${errorMessages}\n\nFull Response:\n${JSON.stringify(data, null, 2)}`, 'success');
                    }
                } else if (data.data?.draftOrderCreate?.draftOrder) {
                    const draftOrder = data.data.draftOrderCreate.draftOrder;
                    showResult(resultId, `✅ SUCCESS: Draft order created successfully!\n\nDraft Order Details:\nID: ${draftOrder.id}\nName: ${draftOrder.name}\nStatus: ${draftOrder.status}\nTotal Price: ${draftOrder.totalPrice}\nLine Items: ${draftOrder.lineItems.edges.length}\n\nFull Response:\n${JSON.stringify(data, null, 2)}`, 'success');
                } else {
                    showResult(resultId, `❓ Unexpected response format\n\nFull Response:\n${JSON.stringify(data, null, 2)}`, 'warning');
                }

            } catch (error) {
                showResult(resultId, `❌ Network error: ${error.message}`, 'error');
            }
        }

        async function runAllTests() {
            hideResult('resultAll');
            showResult('resultAll', '🚀 Starting comprehensive draft order creation tests...\n', 'info');
            
            const tests = [
                { name: 'String Variant ID', type: 'string' },
                { name: 'Numeric Variant ID', type: 'numeric' },
                { name: 'Invalid Variant ID', type: 'invalid' }
            ];

            let allResults = [];
            
            for (const test of tests) {
                showResult('resultAll', `🔄 Running ${test.name} test...\n`, 'info');
                
                try {
                    const { storeUrl, accessToken, testData } = createTestData(test.type);
                    
                    const response = await fetch(`https://${storeUrl}/admin/api/2025-01/graphql.json`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-Shopify-Access-Token': accessToken,
                        },
                        body: JSON.stringify({
                            query: DRAFT_ORDER_CREATE_MUTATION,
                            variables: testData
                        })
                    });

                    const data = await response.json();
                    
                    let result = { name: test.name, success: false, isVariantError: false };
                    
                    if (data.errors) {
                        const errorMessages = data.errors.map(e => e.message).join(' ');
                        result.isVariantError = errorMessages.includes('variant') || errorMessages.includes('Variant');
                    } else if (data.data?.draftOrderCreate?.userErrors?.length > 0) {
                        const errorMessages = data.data.draftOrderCreate.userErrors.map(e => e.message).join(' ');
                        result.isVariantError = errorMessages.includes('variant') || errorMessages.includes('Variant');
                    } else if (data.data?.draftOrderCreate?.draftOrder) {
                        result.success = true;
                    }
                    
                    allResults.push(result);
                    
                } catch (error) {
                    allResults.push({ name: test.name, success: false, error: error.message });
                }
                
                // Small delay between tests
                await new Promise(resolve => setTimeout(resolve, 1000));
            }
            
            // Summary
            const summary = allResults.map(r => {
                if (r.success) return `${r.name}: ✅ SUCCESS`;
                if (r.isVariantError) return `${r.name}: 🚨 VARIANT_ERROR`;
                if (r.error) return `${r.name}: ❌ NETWORK_ERROR`;
                return `${r.name}: ✅ PASSED (other error)`;
            }).join('\n');
            
            const variantErrors = allResults.filter(r => r.isVariantError).length;
            const successes = allResults.filter(r => r.success).length;
            
            showResult('resultAll', `🏁 All tests completed!\n\nSummary:\n${summary}\n\nStatistics:\n✅ Successful orders: ${successes}\n🚨 Variant ID errors: ${variantErrors}\n✅ Other errors: ${allResults.length - successes - variantErrors}\n\n${variantErrors === 0 ? '🎉 SUCCESS: No variant_id validation errors detected!' : '⚠️ WARNING: Some variant_id validation errors still exist.'}`, 'info');
        }
    </script>
</body>
</html>
